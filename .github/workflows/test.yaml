name: Java CI com Maven

on:
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository

    steps:
    - name: Teste no servidor remoto
      uses: appleboy/ssh-action@v1.0.3
      env:
        # Mapeia o Secret do GitHub para uma vari√°vel de ambiente local
        TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        BRANCH: ${{ github.head_ref }}
        REPO_URL: ${{ github.repository }}
        FOLDER: "smtp-build"
        SOURCE: "smtp-build/source"
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 50022
        envs: TOKEN,BRANCH,REPO_URL,FOLDER,SOURCE
        script: |
          AUTH_URL="https://x-access-token:$TOKEN@github.com/$REPO_URL"
          rm -fr $SOURCE \
           && mkdir -p $SOURCE \
           && git clone -b $BRANCH $AUTH_URL $SOURCE \
           && podman run --rm \
             -v "$(pwd)/$SOURCE:/app:Z" \
             -v "$HOME/.m2:/root/.m2:Z" \
             -w /app \
             docker.io/library/maven:3.9.6-eclipse-temurin-21 \
             mvn test -s settings.xml
           && rm -fr $SOURCE \
           && echo 'Test completed'
