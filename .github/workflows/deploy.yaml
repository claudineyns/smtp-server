name: Remote Build and Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy no servidor remoto
      uses: appleboy/ssh-action@v1.0.3
      env:
        # Mapeia o Secret do GitHub para uma vari√°vel de ambiente local
        TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        BRANCH: "main"
        REPO_URL: ${{ github.repository }}
        FOLDER: "smtp-build"
        SOURCE: "smtp-build/source"
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 50022
        envs: TOKEN,BRANCH,REPO_URL,FOLDER,SOURCE
        script: |
          AUTH_URL="https://x-access-token:$TOKEN@github.com/$REPO_URL"
          rm -fr $SOURCE \
           && mkdir -p $SOURCE \
           && git clone -b $BRANCH $AUTH_URL $SOURCE \
           && mvn install -DskipTests -Dnative -f $SOURCE/pom.xml -s $SOURCE/settings.xml \
           && cp $SOURCE/target/smtp*-runner.jar $FOLDER \
           && cp $SOURCE/target/smtp*-runner $FOLDER \
           && rm -fr $SOURCE \
           && echo 'Build completed'
