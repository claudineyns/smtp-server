name: Remote Build and Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Compilação no servidor remoto
      uses: appleboy/ssh-action@v1.0.3
      env:
        # Mapeia o Secret do GitHub para uma variável de ambiente local
        MY_TOKEN: ${{ secrets.GIT_ACCESS_TOKEN }}
        MY_USER: "claudineyns"
        BRANCH: "main"
        REPO_URL: "github.com/claudineyns/smtp-server.git"
        FOLDER: "smtp-build"
        SOURCE: "smtp-build/source"
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 50022
        envs: MY_TOKEN,MY_USER,BRANCH,REPO_URL,FOLDER,SOURCE
        script: |
          AUTH_URL="https://$MY_USER:$MY_TOKEN@$REPO_URL"
          rm -fr $SOURCE \
           && mkdir -p $SOURCE \
           && git clone -b $BRANCH $AUTH_URL $SOURCE \
           && mvn install -DskipTests -Dnative -f $SOURCE/pom.xml -s $SOURCE/settings.xml \
           && cp $SOURCE/target/smtp*-runner.jar $FOLDER \
           && cp $SOURCE/target/smtp*-runner $FOLDER \
           && rm -fr $SOURCE \
           && echo 'Build completed'
